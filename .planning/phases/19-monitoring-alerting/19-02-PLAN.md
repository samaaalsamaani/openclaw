---
phase: 19-monitoring-alerting
plan: 02
type: execute
wave: 2
depends_on: [19-01]
files_modified:
  - src/infra/alert-dispatcher.ts
  - src/infra/alert-dispatcher.test.ts
  - scripts/daily-alert-check.sh
autonomous: true
requirements: [OBS-03, OBS-05, OBS-06]

must_haves:
  truths:
    - "Integration failures (MCP timeouts, SDK errors) are logged with alerts"
    - "Credential expiry warnings appear 7 days before token expiration"
    - "Daily health report delivered via notification"
  artifacts:
    - path: "src/infra/alert-dispatcher.ts"
      provides: "Alert routing and notification delivery"
      exports: ["dispatchAlert", "AlertLevel", "AlertChannel"]
      min_lines: 150
    - path: "scripts/daily-alert-check.sh"
      provides: "Scheduled health monitoring with alerting"
      min_lines: 40
  key_links:
    - from: "alert-dispatcher.ts"
      to: "node-notifier"
      via: "macOS notification delivery"
      pattern: "notifier\\.notify"
    - from: "alert-dispatcher.ts"
      to: "observability.sqlite"
      via: "query recent errors for alert context"
      pattern: "SELECT.*FROM events.*WHERE.*error IS NOT NULL"
    - from: "daily-alert-check.sh"
      to: "health-check.ts"
      via: "runs health check and sends alerts on failures"
      pattern: "bun.*health-check"
---

<objective>
Implement automated alerting system that sends notifications for crashes, failures, and credential expiry.

Purpose: Ensure all failures are detected immediately by monitoring observability events, running scheduled health checks, and sending macOS notifications for critical issues.

Output: Alert dispatcher module with notification delivery, test scaffold, and daily health check script integrated with launchd for scheduled execution.
</objective>

<execution_context>
@/Users/user/.claude/get-shit-done/workflows/execute-plan.md
@/Users/user/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

@.planning/phases/19-monitoring-alerting/19-01-SUMMARY.md
@src/infra/credential-monitor.ts
@src/infra/health-check.ts
</context>

<interfaces>
<!-- Dependencies from Plan 01 -->
From src/infra/health-check.ts:
```typescript
export interface HealthReport {
  timestamp: string;
  services: ServiceStatus[];
  apis: ApiStatus[];
  databases: DatabaseStatus[];
  configs: ConfigStatus[];
  overall: "healthy" | "degraded" | "critical";
}
export async function checkSystemHealth(): Promise<HealthReport>;
```

From src/infra/credential-monitor.ts:

```typescript
import notifier from "node-notifier";
export function sendExpiryNotification(profileId: string, daysLeft: number): void;
export function sendManualRenewalNotification(profileId: string, provider: string): void;
```

Observability events table (for integration failure detection):

```sql
SELECT * FROM events
WHERE category IN ('mcp', 'sdk', 'integration')
  AND error IS NOT NULL
  AND timestamp > datetime('now', '-1 hour')
ORDER BY timestamp DESC;
```

</interfaces>

<tasks>

<task type="auto">
  <name>Task 1: Create alert dispatcher module with notification delivery and alert levels</name>
  <files>src/infra/alert-dispatcher.ts</files>
  <action>
Create alert-dispatcher.ts module with dispatchAlert() function:

**Alert levels and routing:**

```typescript
export enum AlertLevel {
  INFO = "info", // FYI notifications (daily reports)
  WARNING = "warning", // Degraded state, non-critical
  CRITICAL = "critical", // Service down, config invalid
}

export enum AlertChannel {
  NOTIFICATION = "notification", // macOS notification (node-notifier)
  LOG = "log", // Console log only
  OBSERVABILITY = "observability", // Log to observability.sqlite
}

export interface AlertMessage {
  level: AlertLevel;
  title: string;
  message: string;
  source: string; // Component that triggered alert
  metadata?: Record<string, unknown>;
}

export async function dispatchAlert(alert: AlertMessage, channels: AlertChannel[]): Promise<void>;
```

**Implementation:**

- **NOTIFICATION channel**: Use node-notifier for macOS notifications (same pattern as credential-monitor.ts)
  - INFO: No sound, 5-second display
  - WARNING: Sound enabled, 10-second display
  - CRITICAL: Sound enabled, persistent (wait: true), action button "View Logs"
- **LOG channel**: console.log for INFO, console.warn for WARNING, console.error for CRITICAL
- **OBSERVABILITY channel**: INSERT into observability.sqlite events table (category: 'monitoring', action: 'alert_dispatched')

**Integration failure detection:**
Create `detectIntegrationFailures()` helper:

- Query observability.sqlite for recent errors (last 1 hour)
- Filter by category: 'mcp', 'sdk', 'integration'
- Group by error type, count occurrences
- Return summary: `{ errorType: string, count: number, lastSeen: string }[]`
- If count > 5 for same error in 1 hour → dispatch CRITICAL alert

**Daily health summary:**
Create `generateDailySummary()` helper:

- Run checkSystemHealth() from Plan 01
- Format summary: "X/Y services running, A/B APIs available, all configs valid"
- Overall status determines alert level: critical → CRITICAL, degraded → WARNING, healthy → INFO
- Return AlertMessage with formatted summary

**Error handling:**

- If notification fails, fall back to LOG + OBSERVABILITY
- If observability DB unavailable, fall back to LOG only
- Never throw — alerting system must not crash on failure
  </action>
  <verify>
  <automated>
  pnpm test src/infra/alert-dispatcher.test.ts
  </automated>
  </verify>
  <done>
  dispatchAlert() sends notifications via node-notifier for NOTIFICATION channel, logs to observability.sqlite for OBSERVABILITY channel, detectIntegrationFailures() queries events table and groups errors, generateDailySummary() returns AlertMessage with health report
  </done>
  </task>

<task type="auto">
  <name>Task 2: Create test scaffold with placeholder tests for alert dispatch and integration detection</name>
  <files>src/infra/alert-dispatcher.test.ts</files>
  <action>
Create test scaffold following Phase 16 pattern:

```typescript
import { describe, test, expect } from "vitest";
import { dispatchAlert, AlertLevel, AlertChannel } from "./alert-dispatcher.js";

describe("alert-dispatcher", () => {
  test("dispatchAlert accepts AlertMessage and channels", async () => {
    const alert = {
      level: AlertLevel.INFO,
      title: "Test Alert",
      message: "Test message",
      source: "test",
    };

    // Should not throw
    await dispatchAlert(alert, [AlertChannel.LOG]);
    expect(true).toBe(true);
  });

  // TODO: Test notification delivery (mock node-notifier)
  // TODO: Test observability logging (mock database INSERT)
  // TODO: Test alert level routing (CRITICAL vs WARNING vs INFO)
  // TODO: Test detectIntegrationFailures (mock events query)
  // TODO: Test generateDailySummary (mock health check)
  // TODO: Test error handling (notification fails, DB unavailable)
});
```

**Test discovery validation:**

- Vitest discovers and runs test
- Placeholder test passes (validates signature only)
- 6 TODO markers document expected coverage
  </action>
  <verify>
  <automated>
  pnpm test src/infra/alert-dispatcher.test.ts
  </automated>
  </verify>
  <done>
  Test file compiles, vitest discovers test, placeholder test passes, 6 TODO markers present
  </done>
  </task>

<task type="auto">
  <name>Task 3: Create daily alert check script and integrate with launchd schedule</name>
  <files>scripts/daily-alert-check.sh</files>
  <action>
Create daily-alert-check.sh script that:

**Core functionality:**

- Run health check: `bun src/infra/health-check.ts`
- Capture JSON output, parse overall status
- If degraded or critical, dispatch alert via alert-dispatcher
- Check credential expiry: call credential-monitor checkCredentialExpiry()
- Detect integration failures: call alert-dispatcher detectIntegrationFailures()
- Generate daily summary: call alert-dispatcher generateDailySummary()

**Alert dispatch:**

```bash
# Example flow
HEALTH=$(bun -e "import {checkSystemHealth} from './src/infra/health-check.js'; console.log(JSON.stringify(await checkSystemHealth()))")
OVERALL=$(echo "$HEALTH" | jq -r '.overall')

if [[ "$OVERALL" != "healthy" ]]; then
  bun -e "
    import {dispatchAlert, AlertLevel, AlertChannel} from './src/infra/alert-dispatcher.js';
    import {generateDailySummary} from './src/infra/alert-dispatcher.js';
    const summary = await generateDailySummary();
    await dispatchAlert(summary, [AlertChannel.NOTIFICATION, AlertChannel.OBSERVABILITY]);
  "
fi
```

**Integration with existing daily-tasks:**

- This script runs as part of daily-tasks.sh (add to existing launchd job)
- Do NOT create new launchd plist (use existing ai.openclaw.daily-tasks)
- Add call to daily-alert-check.sh in scripts/daily-tasks.sh

**Logging:**

- Log all actions to `~/.openclaw/logs/daily-alerts.log`
- Include timestamp, health status, alerts dispatched
- Rotate log if > 10MB (keep last 3 files)

**Error handling:**

- If Bun unavailable, skip alerts (log warning)
- If health check fails, dispatch CRITICAL alert with error message
- Never exit non-zero (don't block other daily tasks)
  </action>
  <verify>
  <automated>
  bash -n scripts/daily-alert-check.sh && bash -n scripts/daily-tasks.sh && echo "Syntax OK"
  </automated>
  </verify>
  <done>
  daily-alert-check.sh has no syntax errors, integrated into daily-tasks.sh, runs health check and dispatches alerts on failures, logs to daily-alerts.log
  </done>
  </task>

</tasks>

<verification>
Manual verification after implementation:
1. Run `scripts/daily-alert-check.sh` manually — notification appears with daily summary
2. Stop a service: `launchctl stop ai.openclaw.gateway`, run script again — CRITICAL alert appears
3. Check observability.sqlite: `sqlite3 ~/.openclaw/observability.sqlite "SELECT * FROM events WHERE action='alert_dispatched' ORDER BY id DESC LIMIT 3"` — rows exist with alert metadata
4. Verify daily-tasks.sh calls daily-alert-check.sh — grep for function call
</verification>

<success_criteria>

- dispatchAlert() sends macOS notifications for all alert levels with appropriate sound/persistence
- Integration failure detection queries observability events and groups errors
- Daily summary generated from health check results
- daily-alert-check.sh integrated into existing daily-tasks launchd job
- Test scaffold compiles and placeholder test passes
  </success_criteria>

<output>
After completion, create `.planning/phases/19-monitoring-alerting/19-02-SUMMARY.md`
</output>
