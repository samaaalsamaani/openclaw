---
phase: 16-service-hardening
plan: 03
type: execute
wave: 2
depends_on:
  - 16-01
files_modified:
  - ~/.openclaw/cron/ai.openclaw.gateway.plist
  - ~/.openclaw/cron/ai.openclaw.embedding-server.plist
  - ~/.openclaw/cron/ai.openclaw.file-watcher.plist
  - ~/.openclaw/cron/ai.openclaw.emit-server.plist
  - ~/.openclaw/cron/ai.openclaw.daily-tasks.plist
  - ~/.openclaw/cron/ai.openclaw.weekly-tasks.plist
  - ~/.openclaw/cron/ai.openclaw.mcp-kb-server.plist
  - ~/.openclaw/cron/ai.openclaw.mcp-observability-server.plist
  - ~/.openclaw/cron/ai.openclaw.mcp-macos-system.plist
  - ~/.openclaw/cron/ai.openclaw.mcp-google-workspace.plist
  - src/daemon/launchd-plist.ts
  - ~/.openclaw/projects/file-watcher/watcher.sh
  - ~/.claude/mcp-config.json
  - ~/.codex/mcp-config.json
autonomous: true
requirements:
  - SERV-02
  - SERV-05
  - SERV-06

must_haves:
  truths:
    - "All 6 existing launchd services have KeepAlive configured with SuccessfulExit=false"
    - "All services have ThrottleInterval=10 to prevent restart storms"
    - "All services have ExitTimeout=30 for graceful shutdown"
    - "All services have StandardOutPath and StandardErrorPath configured"
    - "Services restart automatically on crash but not on intentional exit"
    - "Exactly 4 MCP server processes running (one per daemon, no zombies)"
    - "Claude Code and Codex CLI connect to MCP daemons instead of spawning servers"
    - "MCP servers survive session termination (no zombie accumulation)"
  artifacts:
    - path: "~/.openclaw/cron/ai.openclaw.gateway.plist"
      provides: "Production-grade launchd configuration"
      contains: "ThrottleInterval"
    - path: "~/.openclaw/cron/ai.openclaw.mcp-kb-server.plist"
      provides: "KB MCP server as launchd daemon"
      contains: "KeepAlive"
    - path: "~/.openclaw/cron/ai.openclaw.mcp-observability-server.plist"
      provides: "Observability MCP server as launchd daemon"
      contains: "KeepAlive"
    - path: "~/.openclaw/cron/ai.openclaw.mcp-macos-system.plist"
      provides: "macOS System MCP server as launchd daemon"
      contains: "KeepAlive"
    - path: "~/.openclaw/cron/ai.openclaw.mcp-google-workspace.plist"
      provides: "Google Workspace MCP server as launchd daemon"
      contains: "KeepAlive"
    - path: "~/.openclaw/projects/file-watcher/watcher.sh"
      provides: "File watcher with error recovery"
      contains: "fswatch"
    - path: "~/.claude/mcp-config.json"
      provides: "Claude Code MCP config pointing to daemons"
      contains: "localhost"
    - path: "~/.codex/mcp-config.json"
      provides: "Codex CLI MCP config pointing to daemons"
      contains: "localhost"
  key_links:
    - from: "launchd"
      to: "all 10 services (6 existing + 4 MCP daemons)"
      via: "KeepAlive restart on crash"
      pattern: "SuccessfulExit.*false"
    - from: "~/.openclaw/cron/*.plist"
      to: "~/.openclaw/logs/*.log"
      via: "StandardOutPath and StandardErrorPath"
      pattern: "StandardErrorPath"
    - from: "Claude Code CLI"
      to: "MCP daemons"
      via: "connect (not spawn)"
      pattern: "localhost.*\\d{4}"
    - from: "Codex CLI"
      to: "MCP daemons"
      via: "connect (not spawn)"
      pattern: "localhost.*\\d{4}"
---

<objective>
Harden all launchd configurations and eliminate MCP server zombie processes by converting to standalone daemons.

Purpose: The system audit revealed 18 zombie MCP servers from 3 old Claude Code sessions causing integration chaos, stale data, and resource contention. The root cause is session-scoped MCP servers that don't clean up when sessions end. Solution: Convert MCP servers to launchd daemons (same pattern as Gateway), ensuring single source of truth and automatic cleanup. Additionally, all 6 existing services need production-grade launchd configurations (KeepAlive, ThrottleInterval, ExitTimeout) for crash recovery and graceful shutdown.

Output:

- All 6 existing launchd services updated with production-grade settings
- 4 new MCP server daemons running under launchd (KB, Observability, macOS System, Google Workspace)
- Zombie cleanup script terminates 18 orphaned processes safely
- Claude Code and Codex CLI configs updated to connect to daemons instead of spawning
- File watcher script hardened with error recovery
- Logging paths configured for all 10 services
  </objective>

<execution_context>
@/Users/user/.claude/get-shit-done/workflows/execute-plan.md
@/Users/user/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/16-service-hardening/16-CONTEXT.md
@.planning/phases/16-service-hardening/16-RESEARCH.md
@docs/plans/2026-02-27-paios-stabilization-design.md

# Existing launchd plist generator

@src/daemon/launchd-plist.ts â€” buildLaunchAgentPlist() function

# Current plist files

@~/.openclaw/cron/ai.openclaw.gateway.plist
@~/.openclaw/cron/ai.openclaw.embedding-server.plist
@~/.openclaw/cron/ai.openclaw.file-watcher.plist
@~/.openclaw/cron/ai.openclaw.daily-tasks.plist
@~/.openclaw/cron/ai.openclaw.weekly-tasks.plist

# MCP configurations

@~/.claude/mcp-config.json
@~/.codex/mcp-config.json

<interfaces>
<!-- launchd plist structure -->

Required plist keys for production hardening:

```xml
<key>KeepAlive</key>
<dict>
    <key>SuccessfulExit</key>
    <false/>  <!-- Restart on crash, not on clean exit -->
</dict>

<key>ThrottleInterval</key>
<integer>10</integer>  <!-- Min 10 seconds between restarts -->

<key>ExitTimeout</key>
<integer>30</integer>  <!-- Wait 30s after SIGTERM before SIGKILL -->

<key>StandardOutPath</key>
<string>/Users/user/.openclaw/logs/[service]-stdout.log</string>

<key>StandardErrorPath</key>
<string>/Users/user/.openclaw/logs/[service]-stderr.log</string>

<key>ProcessType</key>
<string>Background</string>  <!-- Don't block interactive tasks -->
```

MCP daemon plist template (from design doc):

```xml
<key>Label</key>
<string>ai.openclaw.mcp-{name}-server</string>

<key>ProgramArguments</key>
<array>
  <string>/opt/homebrew/opt/node@22/bin/node</string>
  <string>/Users/user/.openclaw/projects/{name}/mcp-server.js</string>
</array>

<key>WorkingDirectory</key>
<string>/Users/user/.openclaw/projects/{name}</string>

<key>RunAtLoad</key>
<true/>
```

Zombie detection pattern:

- Parent process dead = zombie
- Check via `ps -p <pid> -o ppid=` and verify parent exists

MCP config for daemon connection:

```json
{
  "mcpServers": {
    "knowledge-base": {
      "transport": "stdio",
      "command": "nc",
      "args": ["localhost", "3001"]
    }
  }
}
```

</interfaces>
</context>

<tasks>

<task type="auto">
  <name>Task 1: Clean up 18 zombie MCP server processes safely</name>
  <files>
~/.openclaw/scripts/cleanup-mcp-zombies.sh
  </files>
  <action>
Create zombie cleanup script at ~/.openclaw/scripts/cleanup-mcp-zombies.sh:

1. Find all MCP server processes via `ps aux | grep -E "mcp-server|knowledge-base.*server|observability.*server" | grep -v grep`
2. For each MCP server PID, check if parent process is alive via `ps -p <ppid> > /dev/null 2>&1`
3. If parent is dead, kill gracefully: `kill -TERM <pid>`, wait 2 seconds, `kill -9 <pid>` if still alive
4. Exclude Gateway (PID 9568) and embedding-server from kill list (not MCP servers)
5. Log each terminated PID with parent PID to ~/.openclaw/logs/zombie-cleanup.log
6. After cleanup, verify zero zombies via `ps aux | grep mcp-server | grep -v grep | wc -l`
7. Make script executable: `chmod +x cleanup-mcp-zombies.sh`

Script structure:

```bash
#!/bin/bash
# Safe zombie MCP server cleanup
# Only kills MCP servers whose parent process has died

LOG_FILE="$HOME/.openclaw/logs/zombie-cleanup.log"
GATEWAY_PID=9568

log() {
  echo "[$(date '+%Y-%m-%d %H:%M:%S')] $*" | tee -a "$LOG_FILE"
}

log "Starting zombie MCP server cleanup..."

# Get all MCP server PIDs
MCP_PIDS=$(ps aux | grep -E "mcp-server|knowledge-base.*server|observability.*server" | grep -v grep | awk '{print $2}')

KILLED_COUNT=0
for pid in $MCP_PIDS; do
  # Skip Gateway (not an MCP server)
  if [ "$pid" = "$GATEWAY_PID" ]; then
    continue
  fi

  # Check if parent is alive
  ppid=$(ps -p "$pid" -o ppid= 2>/dev/null | xargs)
  if [ -z "$ppid" ] || ! ps -p "$ppid" > /dev/null 2>&1; then
    log "Killing zombie MCP server: PID $pid (parent $ppid dead)"
    kill -TERM "$pid" 2>/dev/null
    sleep 2
    # Force kill if still alive
    if ps -p "$pid" > /dev/null 2>&1; then
      kill -9 "$pid" 2>/dev/null
    fi
    KILLED_COUNT=$((KILLED_COUNT + 1))
  fi
done

log "Cleanup complete. Killed $KILLED_COUNT zombie processes."

# Verify cleanup
REMAINING=$(ps aux | grep -E "mcp-server" | grep -v grep | wc -l | xargs)
log "Remaining MCP server processes: $REMAINING (expect 0 before daemon start)"
```

Run the script immediately after creation to clean up existing zombies.

Why this is safe: Only kills processes whose parent has died (zombies), excludes Gateway PID explicitly, uses SIGTERM first for graceful shutdown, logs all actions for audit.
</action>
<verify>
<automated>bash ~/.openclaw/scripts/cleanup-mcp-zombies.sh && ps aux | grep mcp-server | grep -v grep | wc -l</automated>
<manual>Check ~/.openclaw/logs/zombie-cleanup.log for killed PIDs</manual>
</verify>
<done>Cleanup script exists, executable, and successfully terminated 18 zombie MCP servers. Zero MCP server processes remain.</done>
</task>

<task type="auto">
  <name>Task 2: Update buildLaunchAgentPlist() and create 4 MCP daemon plists</name>
  <files>
src/daemon/launchd-plist.ts
~/.openclaw/cron/ai.openclaw.mcp-kb-server.plist
~/.openclaw/cron/ai.openclaw.mcp-observability-server.plist
~/.openclaw/cron/ai.openclaw.mcp-macos-system.plist
~/.openclaw/cron/ai.openclaw.mcp-google-workspace.plist
  </files>
  <action>
Part A: Update src/daemon/launchd-plist.ts buildLaunchAgentPlist() function with production-grade defaults:

1. Add KeepAlive configuration with SuccessfulExit=false (restart on crash only)
2. Add ThrottleInterval=10 (10 seconds minimum between restarts)
3. Add ExitTimeout=30 (30 seconds for graceful shutdown)
4. Add ProcessType="Background" (don't block interactive tasks)
5. Ensure StandardOutPath and StandardErrorPath are always set (to ~/.openclaw/logs/[label]-{stdout,stderr}.log)
6. Add comment explaining each setting

Pattern: Update the plist builder to include these defaults for all services.

Example additions:

```typescript
const plist = {
  Label: label,
  RunAtLoad: runAtLoad,
  KeepAlive: {
    SuccessfulExit: false, // Restart on crash, not on clean exit
  },
  ThrottleInterval: 10, // Min 10 seconds between restarts (launchd minimum)
  ExitTimeout: 30, // Wait 30s after SIGTERM before SIGKILL
  ProcessType: "Background", // Don't block interactive tasks
  StandardOutPath: path.join(HOME, ".openclaw", "logs", `${label}-stdout.log`),
  StandardErrorPath: path.join(HOME, ".openclaw", "logs", `${label}-stderr.log`),
  // ... rest of existing config
};
```

Part B: Create 4 MCP daemon plist files using buildLaunchAgentPlist() or manual generation:

1. ai.openclaw.mcp-kb-server.plist
   - Label: ai.openclaw.mcp-kb-server
   - ProgramArguments: [/opt/homebrew/opt/node@22/bin/node, /Users/user/.openclaw/projects/knowledge-base/mcp-server.js]
   - WorkingDirectory: /Users/user/.openclaw/projects/knowledge-base
   - RunAtLoad: true
   - KeepAlive: {SuccessfulExit: false}
   - Port: 3001 (pass as env var MCP_PORT=3001)

2. ai.openclaw.mcp-observability-server.plist
   - Label: ai.openclaw.mcp-observability-server
   - ProgramArguments: [/opt/homebrew/opt/node@22/bin/node, /Users/user/.openclaw/projects/observability/mcp-server.js]
   - WorkingDirectory: /Users/user/.openclaw/projects/observability
   - Port: 3002

3. ai.openclaw.mcp-macos-system.plist
   - Label: ai.openclaw.mcp-macos-system
   - ProgramArguments: [/opt/homebrew/opt/node@22/bin/node, /Users/user/.openclaw/projects/macos-system/mcp-server.js]
   - WorkingDirectory: /Users/user/.openclaw/projects/macos-system
   - Port: 3003

4. ai.openclaw.mcp-google-workspace.plist
   - Label: ai.openclaw.mcp-google-workspace
   - ProgramArguments: [/opt/homebrew/opt/node@22/bin/node, /Users/user/.openclaw/projects/google-workspace/mcp-server.js]
   - WorkingDirectory: /Users/user/.openclaw/projects/google-workspace
   - Port: 3004

Include all hardening settings from Part A in each MCP daemon plist.

Why separate tasks: Zombie cleanup must complete before daemons start (prevents port conflicts, ensures clean slate).

Why these ports: Sequential allocation (3001-3004), avoids conflicts with Gateway (18789) and embedding-server (11435).
</action>
<verify>
<automated>pnpm test src/daemon/launchd-plist.test.ts --run</automated>
<manual>for f in ~/.openclaw/cron/ai.openclaw.mcp-\*.plist; do plutil -lint "$f" || echo "INVALID: $f"; done</manual>
</verify>
<done>buildLaunchAgentPlist() includes all hardening settings. 4 MCP daemon plists created and pass plutil validation.</done>
</task>

<task type="auto">
  <name>Task 3: Regenerate 6 existing launchd plists and harden file watcher</name>
  <files>
~/.openclaw/cron/ai.openclaw.gateway.plist
~/.openclaw/cron/ai.openclaw.embedding-server.plist
~/.openclaw/cron/ai.openclaw.file-watcher.plist
~/.openclaw/cron/ai.openclaw.emit-server.plist
~/.openclaw/cron/ai.openclaw.daily-tasks.plist
~/.openclaw/cron/ai.openclaw.weekly-tasks.plist
~/.openclaw/projects/file-watcher/watcher.sh
  </files>
  <action>
Part A: Regenerate all 6 existing launchd plists using updated buildLaunchAgentPlist():

1. Read each existing plist to extract current ProgramArguments and environment variables
2. Call buildLaunchAgentPlist() with updated defaults from Task 2
3. Write updated plist to ~/.openclaw/cron/[service].plist
4. Preserve service-specific settings (StartCalendarInterval for daily/weekly tasks)

For calendar services (daily/weekly), ensure KeepAlive is NOT set (conflicts with StartCalendarInterval). These run on schedule, not continuously.

After regeneration, validate each plist:

- Has ThrottleInterval >= 10
- Has ExitTimeout >= 30
- Has StandardOutPath and StandardErrorPath
- Continuous services have KeepAlive with SuccessfulExit=false
- Calendar services have StartCalendarInterval, no KeepAlive
- All have ProcessType="Background"

Part B: Update ~/.openclaw/projects/file-watcher/watcher.sh with error recovery:

1. Add logging function: log() { echo "[$(date '+%Y-%m-%d %H:%M:%S')] $\*" >&2; }
2. Log startup: log "File watcher starting for directories: ${WATCH_DIRS[@]}"
3. Add error recovery at end of script: if fswatch exits, log error and exit 1 (launchd will restart)
4. Add comment explaining fswatch reliability

Example additions:

```bash
log() {
  echo "[$(date '+%Y-%m-%d %H:%M:%S')] $*" >&2
}

log "File watcher starting for: ${WATCH_DIRS[@]}"

fswatch --event Created --recursive --one-event "${WATCH_DIRS[@]}" | while read -r file; do
  log "Detected: $file"
  "$HOME/.openclaw/projects/file-watcher/handler.sh" "$file" &
done

# If fswatch exits (shouldn't happen), log and exit
log "ERROR: fswatch exited unexpectedly"
exit 1
```

Why regenerate instead of manual edit: Ensures consistency, prevents XML escaping errors, applies all hardening patterns uniformly.
</action>
<verify>
<automated>for f in ~/.openclaw/cron/_.plist; do plutil -lint "$f" || echo "INVALID: $f"; done</automated>
<manual>grep -l "ThrottleInterval" ~/.openclaw/cron/_.plist | wc -l (expect 10 = 6 existing + 4 MCP)</manual>
<manual>bash -n ~/.openclaw/projects/file-watcher/watcher.sh</manual>
</verify>
<done>All 6 existing plists updated with production hardening. watcher.sh has logging and error recovery. All 10 plists pass plutil validation.</done>
</task>

<task type="auto">
  <name>Task 4: Load MCP daemons and update CLI MCP configs to connect instead of spawn</name>
  <files>
~/.claude/mcp-config.json
~/.codex/mcp-config.json
  </files>
  <action>
Part A: Load 4 MCP daemon services via launchd:

1. Load each plist: `launchctl load ~/.openclaw/cron/ai.openclaw.mcp-kb-server.plist` (repeat for observability, macos-system, google-workspace)
2. Wait 5 seconds for startup
3. Verify all 4 daemons running: `launchctl list | grep "ai.openclaw.mcp-"` (expect 4 entries with PIDs, not "-")
4. Check logs for errors: `tail -20 ~/.openclaw/logs/ai.openclaw.mcp-*-stderr.log`

Part B: Update Claude Code MCP config (~/.claude/mcp-config.json) to connect to daemons:

Backup existing config first: `cp ~/.claude/mcp-config.json ~/.claude/mcp-config.json.backup`

Update mcpServers entries to use TCP connection instead of spawning:

```json
{
  "mcpServers": {
    "knowledge-base": {
      "transport": "stdio",
      "command": "nc",
      "args": ["localhost", "3001"]
    },
    "observability": {
      "transport": "stdio",
      "command": "nc",
      "args": ["localhost", "3002"]
    },
    "macos-system": {
      "transport": "stdio",
      "command": "nc",
      "args": ["localhost", "3003"]
    },
    "google-workspace": {
      "transport": "stdio",
      "command": "nc",
      "args": ["localhost", "3004"]
    }
  }
}
```

Part C: Update Codex CLI MCP config (~/.codex/mcp-config.json) with same pattern.

Backup first: `cp ~/.codex/mcp-config.json ~/.codex/mcp-config.json.backup`

Apply same mcpServers structure as Claude Code config.

Why nc (netcat): Bridges stdio MCP transport to TCP sockets, allows CLI to connect to daemon servers without changing MCP protocol.

Why this works: MCP daemons listen on TCP ports (3001-3004), nc connects and pipes stdio bidirectionally, CLI sees normal MCP stdio transport.

Validation: After loading daemons and updating configs, test by opening Claude Code and calling a KB tool. Should connect to daemon at localhost:3001, not spawn new process.
</action>
<verify>
<automated>launchctl list | grep "ai.openclaw.mcp-" | wc -l</automated>
<manual>ps aux | grep mcp-server | grep -v grep | wc -l (expect exactly 4 processes)</manual>
<manual>cat ~/.claude/mcp-config.json | grep -c "localhost" (expect 4 entries)</manual>
</verify>
<done>4 MCP daemons loaded and running via launchd. Claude Code and Codex CLI configs updated to connect to daemons. Zero zombie processes remain.</done>
</task>

</tasks>

<verification>
**Phase gate checks:**

1. Zombie cleanup validation
   - Run: `ps aux | grep mcp-server | grep -v grep | wc -l`
   - Expected: 4 (exactly 4 daemon processes, no zombies)

2. launchd plist validation
   - Run: `for f in ~/.openclaw/cron/*.plist; do plutil -lint "$f" || echo "INVALID: $f"; done`
   - Expected: All plists valid, no errors

3. Hardening settings present
   - Run: `grep -c "ThrottleInterval" ~/.openclaw/cron/*.plist`
   - Expected: Count = 10 (6 existing + 4 MCP daemons)

4. Logging configured
   - Run: `grep -c "StandardErrorPath" ~/.openclaw/cron/*.plist`
   - Expected: Count = 10

5. MCP daemon health
   - Run: `launchctl list | grep "ai.openclaw.mcp-" | grep -v "-"`
   - Expected: 4 services with PIDs (not "-")

6. CLI MCP config validation
   - Run: `cat ~/.claude/mcp-config.json | jq '.mcpServers | keys'`
   - Expected: ["knowledge-base", "observability", "macos-system", "google-workspace"]

7. File watcher script
   - Run: `bash -n ~/.openclaw/projects/file-watcher/watcher.sh`
   - Expected: No syntax errors

8. Service restart test
   - Run: `launchctl unload ~/.openclaw/cron/ai.openclaw.gateway.plist && launchctl load ~/.openclaw/cron/ai.openclaw.gateway.plist && sleep 5 && launchctl list | grep gateway`
   - Expected: Gateway running (PID != "-")

9. Type checking
   - Run: `pnpm check`
   - Expected: No TypeScript errors

10. MCP daemon persistence test - Run: Start Claude Code session, call KB tool, close session, verify MCP daemon still running - Expected: MCP server process survives session termination
    </verification>

<success_criteria>
**Observable outcomes:**

- Exactly 4 MCP server processes running (one per daemon, no zombies)
- All 10 launchd plists (6 existing + 4 MCP) have KeepAlive, ThrottleInterval=10, ExitTimeout=30
- All services have StandardOutPath and StandardErrorPath configured
- Services restart automatically on crash (test via pkill -KILL)
- Services respect graceful shutdown (test via pkill -TERM, check logs for cleanup)
- MCP servers survive Claude Code session termination (no new zombies accumulate)
- Claude Code and Codex CLI successfully connect to MCP daemons via localhost TCP
- File watcher logs startup and errors to stderr
- Calendar services (daily/weekly) run on schedule, not continuously
- All plist files pass plutil validation
- Zero zombie MCP server processes after 24 hours of operation
  </success_criteria>

<output>
After completion, create `.planning/phases/16-service-hardening/16-03-SUMMARY.md` documenting:
- launchd hardening patterns (KeepAlive, ThrottleInterval, ExitTimeout)
- MCP daemon architecture (standalone services vs session-scoped)
- Zombie cleanup procedure and safety mechanisms
- Service restart behavior (crash vs clean exit)
- Logging configuration for all 10 services
- File watcher error recovery implementation
- CLI MCP config changes (spawn vs connect)
- Testing procedures for launchd services and MCP daemons
- Port allocation (3001-3004 for MCP daemons)
</output>
