---
phase: 16-service-hardening
plan: 03
type: execute
wave: 2
depends_on:
  - 16-01
files_modified:
  - ~/.openclaw/cron/ai.openclaw.gateway.plist
  - ~/.openclaw/cron/ai.openclaw.embedding-server.plist
  - ~/.openclaw/cron/ai.openclaw.file-watcher.plist
  - ~/.openclaw/cron/ai.openclaw.emit-server.plist
  - ~/.openclaw/cron/ai.openclaw.daily-tasks.plist
  - ~/.openclaw/cron/ai.openclaw.weekly-tasks.plist
  - src/daemon/launchd-plist.ts
  - ~/.openclaw/projects/file-watcher/watcher.sh
autonomous: true
requirements:
  - SERV-02
  - SERV-05
  - SERV-06

must_haves:
  truths:
    - "All 6 launchd services have KeepAlive configured with SuccessfulExit=false"
    - "All services have ThrottleInterval=10 to prevent restart storms"
    - "All services have ExitTimeout=30 for graceful shutdown"
    - "All services have StandardOutPath and StandardErrorPath configured"
    - "Services restart automatically on crash but not on intentional exit"
  artifacts:
    - path: "~/.openclaw/cron/ai.openclaw.gateway.plist"
      provides: "Production-grade launchd configuration"
      contains: "ThrottleInterval"
    - path: "~/.openclaw/cron/ai.openclaw.embedding-server.plist"
      provides: "Production-grade launchd configuration"
      contains: "ExitTimeout"
    - path: "~/.openclaw/projects/file-watcher/watcher.sh"
      provides: "File watcher with error recovery"
      contains: "fswatch"
  key_links:
    - from: "launchd"
      to: "all 6 services"
      via: "KeepAlive restart on crash"
      pattern: "SuccessfulExit.*false"
    - from: "~/.openclaw/cron/*.plist"
      to: "~/.openclaw/logs/*.log"
      via: "StandardOutPath and StandardErrorPath"
      pattern: "StandardErrorPath"
---

<objective>
Harden launchd configurations with production-grade settings for automatic crash recovery, graceful shutdown, and comprehensive logging.

Purpose: launchd is macOS's native process supervisor. Proper configuration ensures services restart automatically on crash (but not on intentional exit), have time for graceful shutdown, and produce logs for troubleshooting.

Output:

- All 6 launchd plists updated with KeepAlive, ThrottleInterval, ExitTimeout
- File watcher script hardened with error recovery
- Logging paths configured for all services
  </objective>

<execution_context>
@/Users/user/.claude/get-shit-done/workflows/execute-plan.md
@/Users/user/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/16-service-hardening/16-CONTEXT.md
@.planning/phases/16-service-hardening/16-RESEARCH.md

# Existing launchd plist generator

@src/daemon/launchd-plist.ts — buildLaunchAgentPlist() function

# Current plist files

@~/.openclaw/cron/ai.openclaw.gateway.plist
@~/.openclaw/cron/ai.openclaw.embedding-server.plist
@~/.openclaw/cron/ai.openclaw.file-watcher.plist
@~/.openclaw/cron/ai.openclaw.daily-tasks.plist
@~/.openclaw/cron/ai.openclaw.weekly-tasks.plist

<interfaces>
<!-- launchd plist structure -->

Required plist keys for production hardening:

```xml
<key>KeepAlive</key>
<dict>
    <key>SuccessfulExit</key>
    <false/>  <!-- Restart on crash, not on clean exit -->
</dict>

<key>ThrottleInterval</key>
<integer>10</integer>  <!-- Min 10 seconds between restarts -->

<key>ExitTimeout</key>
<integer>30</integer>  <!-- Wait 30s after SIGTERM before SIGKILL -->

<key>StandardOutPath</key>
<string>/Users/user/.openclaw/logs/[service]-stdout.log</string>

<key>StandardErrorPath</key>
<string>/Users/user/.openclaw/logs/[service]-stderr.log</string>

<key>ProcessType</key>
<string>Background</string>  <!-- Don't block interactive tasks -->
```

launchd restart environment variables:

- LAUNCHD_RESTART_COUNT: Number of restarts since load
  </interfaces>
  </context>

<tasks>

<task type="auto">
  <name>Task 1: Update buildLaunchAgentPlist() with production-grade defaults</name>
  <files>
src/daemon/launchd-plist.ts
  </files>
  <action>
Update src/daemon/launchd-plist.ts buildLaunchAgentPlist() function:
1. Add KeepAlive configuration with SuccessfulExit=false (restart on crash only)
2. Add ThrottleInterval=10 (10 seconds minimum between restarts)
3. Add ExitTimeout=30 (30 seconds for graceful shutdown)
4. Add ProcessType="Background" (don't block interactive tasks)
5. Ensure StandardOutPath and StandardErrorPath are always set (to ~/.openclaw/logs/[label]-{stdout,stderr}.log)
6. Add comment explaining each setting

Pattern: Update the plist builder, not individual files. Regenerate plists in next task.

Example additions to buildLaunchAgentPlist():

```typescript
const plist = {
  Label: label,
  RunAtLoad: runAtLoad,
  KeepAlive: {
    SuccessfulExit: false, // Restart on crash, not on clean exit
  },
  ThrottleInterval: 10, // Min 10 seconds between restarts (launchd minimum)
  ExitTimeout: 30, // Wait 30s after SIGTERM before SIGKILL
  ProcessType: "Background", // Don't block interactive tasks
  StandardOutPath: path.join(HOME, ".openclaw", "logs", `${label}-stdout.log`),
  StandardErrorPath: path.join(HOME, ".openclaw", "logs", `${label}-stderr.log`),
  // ... rest of existing config
};
```

Why SuccessfulExit=false: Restart on crashes (exit code != 0), but respect intentional shutdowns (exit code 0).

Why ThrottleInterval=10: launchd enforces minimum 10 seconds even if you set lower. Explicit setting documents this behavior.

Why ExitTimeout=30: Gateway crash recovery in Plan 16-01 needs time to log exit event and cleanup resources.
</action>
<verify>
<automated>pnpm test src/daemon/launchd-plist.test.ts --run</automated>
</verify>
<done>buildLaunchAgentPlist() includes KeepAlive, ThrottleInterval, ExitTimeout, ProcessType. Tests validate structure.</done>
</task>

<task type="auto">
  <name>Task 2: Regenerate all 6 launchd plists and validate configurations</name>
  <files>
~/.openclaw/cron/ai.openclaw.gateway.plist
~/.openclaw/cron/ai.openclaw.embedding-server.plist
~/.openclaw/cron/ai.openclaw.file-watcher.plist
~/.openclaw/cron/ai.openclaw.emit-server.plist
~/.openclaw/cron/ai.openclaw.daily-tasks.plist
~/.openclaw/cron/ai.openclaw.weekly-tasks.plist
  </files>
  <action>
Regenerate all 6 launchd plist files using updated buildLaunchAgentPlist():
1. Read each existing plist to extract current ProgramArguments and environment variables
2. Call buildLaunchAgentPlist() with updated defaults from Task 1
3. Write updated plist to ~/.openclaw/cron/[service].plist
4. Preserve any service-specific settings (StartCalendarInterval for daily/weekly tasks)

Services to update:

- ai.openclaw.gateway.plist — Gateway daemon (continuous)
- ai.openclaw.embedding-server.plist — Embedding server (continuous)
- ai.openclaw.file-watcher.plist — File watcher daemon (continuous)
- ai.openclaw.emit-server.plist — Observability emitter (continuous)
- ai.openclaw.daily-tasks.plist — Daily heartbeat (calendar interval)
- ai.openclaw.weekly-tasks.plist — Weekly reflection (calendar interval)

For calendar services (daily/weekly), ensure KeepAlive is NOT set (conflicts with StartCalendarInterval). These run on schedule, not continuously.

After regeneration, validate each plist:

- Has ThrottleInterval >= 10
- Has ExitTimeout >= 30
- Has StandardOutPath and StandardErrorPath
- Continuous services have KeepAlive with SuccessfulExit=false
- Calendar services have StartCalendarInterval, no KeepAlive
- All have ProcessType="Background"

Why regenerate instead of manual edit: Ensures consistency, prevents XML escaping errors, applies all hardening patterns uniformly.
</action>
<verify>
<automated>for f in ~/.openclaw/cron/_.plist; do plutil -lint "$f" || echo "INVALID: $f"; done</automated>
<manual>grep -l "ThrottleInterval" ~/.openclaw/cron/_.plist | wc -l (expect 6)</manual>
<manual>grep -l "ExitTimeout" ~/.openclaw/cron/\*.plist | wc -l (expect 6)</manual>
</verify>
<done>All 6 plists updated with production hardening. plutil validation passes. ThrottleInterval and ExitTimeout present in all files.</done>
</task>

<task type="auto">
  <name>Task 3: Harden file watcher script with error recovery and logging</name>
  <files>
~/.openclaw/projects/file-watcher/watcher.sh
  </files>
  <action>
Update ~/.openclaw/projects/file-watcher/watcher.sh with error recovery:
1. Add logging function: log() { echo "[$(date '+%Y-%m-%d %H:%M:%S')] $*" >&2; }
2. Log startup: log "File watcher starting for directories: ${WATCH_DIRS[@]}"
3. Add error recovery at end of script: if fswatch exits, log error and exit 1 (launchd will restart)
4. Add comment explaining fswatch reliability: "fswatch handles FSEvents natively on macOS, scales to 500GB+ with no performance issues"
5. Ensure existing fswatch flags are optimal: --event Created --recursive --one-event

Example additions:

```bash
log() {
  echo "[$(date '+%Y-%m-%d %H:%M:%S')] $*" >&2
}

log "File watcher starting for: ${WATCH_DIRS[@]}"

# fswatch handles FSEvents natively on macOS, scales to 500GB+ with no performance issues
# --event Created = only trigger on new files, not modifications
# --recursive = watch subdirectories
# --one-event = batch rapid changes (screenshot bursts)
fswatch --event Created --recursive --one-event "${WATCH_DIRS[@]}" | while read -r file; do
  log "Detected: $file"
  "$HOME/.openclaw/projects/file-watcher/handler.sh" "$file" &
done

# If fswatch exits (shouldn't happen), log and exit
# launchd will restart via KeepAlive
log "ERROR: fswatch exited unexpectedly"
exit 1
```

Why exit 1 on fswatch failure: Signals to launchd that restart is needed. KeepAlive with SuccessfulExit=false will restart the service.

Why log to stderr: launchd StandardErrorPath captures troubleshooting info. Stdout is for normal event logging.
</action>
<verify>
<manual>bash -n ~/.openclaw/projects/file-watcher/watcher.sh (syntax check)</manual>
<manual>launchctl unload ~/.openclaw/cron/ai.openclaw.file-watcher.plist && launchctl load ~/.openclaw/cron/ai.openclaw.file-watcher.plist && sleep 2 && launchctl list | grep file-watcher</manual>
</verify>
<done>watcher.sh has logging, error recovery, and exits cleanly on fswatch failure. Script syntax valid.</done>
</task>

</tasks>

<verification>
**Phase gate checks:**

1. launchd plist validation
   - Run: `for f in ~/.openclaw/cron/*.plist; do plutil -lint "$f" || echo "INVALID: $f"; done`
   - Expected: All plists valid, no errors

2. Hardening settings present
   - Run: `grep -c "ThrottleInterval" ~/.openclaw/cron/*.plist`
   - Expected: Count = 6 (all services)

3. Logging configured
   - Run: `grep -c "StandardErrorPath" ~/.openclaw/cron/*.plist`
   - Expected: Count = 6 (all services)

4. File watcher script
   - Run: `bash -n ~/.openclaw/projects/file-watcher/watcher.sh`
   - Expected: No syntax errors

5. Service restart test
   - Run: `launchctl unload ~/.openclaw/cron/ai.openclaw.gateway.plist && launchctl load ~/.openclaw/cron/ai.openclaw.gateway.plist && sleep 5 && launchctl list | grep gateway`
   - Expected: Gateway running (PID != "-")

6. Type checking
   - Run: `pnpm check`
   - Expected: No TypeScript errors
     </verification>

<success_criteria>
**Observable outcomes:**

- All 6 launchd plists have KeepAlive, ThrottleInterval=10, ExitTimeout=30
- All services have StandardOutPath and StandardErrorPath configured
- Services restart automatically on crash (test via pkill -KILL)
- Services respect graceful shutdown (test via pkill -TERM, check logs for cleanup)
- File watcher logs startup and errors to stderr
- Calendar services (daily/weekly) run on schedule, not continuously
- All plist files pass plutil validation
  </success_criteria>

<output>
After completion, create `.planning/phases/16-service-hardening/16-03-SUMMARY.md` documenting:
- launchd hardening patterns (KeepAlive, ThrottleInterval, ExitTimeout)
- Service restart behavior (crash vs clean exit)
- Logging configuration for all services
- File watcher error recovery implementation
- Testing procedures for launchd services
</output>
