---
phase: 18-data-integrity-config-safety
plan: "03"
type: execute
wave: 3
depends_on: ["18-01", "18-02"]
files_modified:
  - scripts/cleanup-placeholder-dbs.sh
  - scripts/load-env.sh
autonomous: true
requirements: [DATA-05, DATA-07]

must_haves:
  truths:
    - Placeholder 0-byte SQLite files removed from ~/.openclaw/
    - Only real databases remain (kb, observability, social-history, autonomy, ceo)
    - load-env.sh reads auth-profiles.json only (no plist fallback)
    - API keys load from single source of truth (auth-profiles.json)
  artifacts:
    - path: scripts/cleanup-placeholder-dbs.sh
      provides: Safe removal of 0-byte placeholder files
      contains: "lsof"
      min_lines: 30
    - path: scripts/load-env.sh
      provides: Auth-profiles-only credential loading
      contains: "auth-profiles.json"
      not_contains: "plist.*fallback"
  key_links:
    - from: scripts/cleanup-placeholder-dbs.sh
      to: ~/.openclaw/ filesystem
      via: "removes 0-byte files after lsof check"
      pattern: "rm.*\\.sqlite"
    - from: scripts/load-env.sh
      to: ~/.openclaw/auth-profiles.json
      via: "loads API keys from auth-profiles"
      pattern: "auth-profiles\\.json"
---

<objective>
Clean up legacy placeholder files and eliminate plist fallback from credential loading to ensure single source of truth.

Purpose: Three 0-byte placeholder SQLite files confuse debugging (which db is real?). Plist fallback causes auth-profiles.json drift (keys in plist but not in profiles). Clean slate = clear ownership.

Output: Migration script to remove placeholders safely, load-env.sh updated to use auth-profiles.json exclusively.
</objective>

<execution_context>
@/Users/user/.claude/get-shit-done/workflows/execute-plan.md
@/Users/user/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/18-data-integrity-config-safety/18-CONTEXT.md
@.planning/phases/18-data-integrity-config-safety/18-RESEARCH.md

# Known placeholder files (from discovery)

# /Users/user/.openclaw/projects/social-history.sqlite (0 bytes)

# /Users/user/.openclaw/social.sqlite (0 bytes)

# /Users/user/.openclaw/knowledge-base.sqlite (0 bytes)

</context>

<interfaces>
<!-- Key patterns and constraints -->

From MEMORY.md (user's system snapshot):

```
Real DBs: ~/.openclaw/{observability,social-history,autonomy}.sqlite
Real DBs: ~/.openclaw/projects/knowledge-base/kb.sqlite
Real DBs: ~/.openclaw/memory/main.sqlite
Real DBs: ~/.openclaw/projects/personal-ceo/ceo.sqlite

Stale 0-byte placeholders (ignore these):
- ~/.openclaw/projects/social-history.sqlite
- ~/.openclaw/social.sqlite
- ~/.openclaw/knowledge-base.sqlite
```

From scripts/load-env.sh (existing pattern - needs update):

```bash
# Current (WRONG): Falls back to plist if auth-profiles missing
# Target (RIGHT): auth-profiles.json is single source of truth
```

From lsof command (check open file handles):

```bash
lsof +D ~/.openclaw | grep -E '\.sqlite$'
# Returns: open database files with PIDs
# Safe to delete if: file NOT in lsof output
```

</interfaces>

<tasks>

<task type="auto">
  <name>Task 1: Create safe placeholder cleanup script</name>
  <files>
    scripts/cleanup-placeholder-dbs.sh
  </files>
  <action>
Create scripts/cleanup-placeholder-dbs.sh with:

1. Header: `#!/bin/bash` + "PAIOS Phase 18 - Remove placeholder SQLite files" comment
2. Set -e (exit on error)
3. Define placeholder files array:
   ```bash
   PLACEHOLDERS=(
     "$HOME/.openclaw/projects/social-history.sqlite"
     "$HOME/.openclaw/social.sqlite"
     "$HOME/.openclaw/knowledge-base.sqlite"
   )
   ```
4. For each file in PLACEHOLDERS:
   - Check if file exists: `[ -f "$file" ]` || continue
   - Check file size is 0: `[ ! -s "$file" ]` (! -s means empty)
   - If NOT empty: log warning "File not empty, skipping: $file" and continue
   - Check if any process has file open: `lsof "$file" 2>/dev/null`
   - If open: log warning "File in use, skipping: $file" and continue
   - If passes checks: `rm "$file"` and log "Removed placeholder: $file"
5. Log summary: "Cleanup complete. Remaining databases:" + `ls -lh ~/.openclaw/*.sqlite ~/.openclaw/**/*.sqlite 2>/dev/null || true`
6. Make executable: chmod +x

Why lsof check: Even 0-byte files can have open file descriptors. Deleting while open causes process crashes.

Why size check: Double-check safety. If file grew to non-zero, it's not a placeholder anymore (migration or new data).

Why continue on error: Don't abort cleanup if one file check fails. Process remaining files.

Note: This is one-time migration script. User runs manually, not in launchd. Document in plan output how to run.
</action>
<verify>
<automated>bash -n scripts/cleanup-placeholder-dbs.sh && chmod +x scripts/cleanup-placeholder-dbs.sh</automated>
</verify>
<done>

- cleanup-placeholder-dbs.sh exists and is executable
- Script syntax validation passes
- lsof check prevents deleting files with open handles
- Size check ensures only 0-byte files are removed
  </done>
  </task>

<task type="auto">
  <name>Task 2: Remove plist fallback from load-env.sh</name>
  <files>
    scripts/load-env.sh
  </files>
  <action>
Update scripts/load-env.sh to use auth-profiles.json as single source of truth:

1. Read existing load-env.sh to understand current structure
2. Find any plist fallback logic (grep for "plist" or ".plist" or "defaults read")
3. Locate auth-profiles.json loading section (should exist based on MEMORY.md)
4. Remove plist fallback entirely:
   - Delete any `defaults read` commands for API keys
   - Delete any conditional loading from plist if auth-profiles missing
   - Ensure auth-profiles.json is the ONLY source for credentials
5. Preserve existing logic for:
   - Environment variable exports (ANTHROPIC_API_KEY, OPENAI_API_KEY, etc.)
   - Path resolution for auth-profiles.json
   - Error handling if auth-profiles.json missing (fail with clear message, don't fallback)
6. Add comment at top: "# Auth-profiles.json is single source of truth (no plist fallback)"
7. Update error messages to point to auth-profiles.json if keys missing

Why remove fallback: Two sources of truth cause drift. Gateway writes to auth-profiles, shell reads from plist → keys desync. Single source = consistency.

Why fail on missing: If auth-profiles.json missing, system is broken. Silent fallback hides the problem. Fail fast with clear error.

Pattern: If current script has `if [ -f auth-profiles.json ]; then load_from_profiles; else load_from_plist; fi`, replace with `if [ -f auth-profiles.json ]; then load_from_profiles; else echo "ERROR: auth-profiles.json missing" && exit 1; fi`.
</action>
<verify>
<automated>bash -n scripts/load-env.sh && grep -q "auth-profiles.json" scripts/load-env.sh && ! grep -qi "plist.\*fallback" scripts/load-env.sh</automated>
</verify>
<done>

- load-env.sh loads credentials from auth-profiles.json only
- No plist fallback logic remains (grep confirms absence)
- Script syntax validation passes
- Clear error message if auth-profiles.json missing
- Single source of truth established for API credentials
  </done>
  </task>

<task type="auto">
  <name>Task 3: Document migration and verify cleanup</name>
  <files>
    scripts/cleanup-placeholder-dbs.sh
  </files>
  <action>
Add usage documentation to cleanup-placeholder-dbs.sh header:

```bash
#!/bin/bash
# PAIOS Phase 18 - Remove placeholder SQLite files
#
# PURPOSE: Clean up legacy 0-byte placeholder databases from old architecture
# USAGE: ./scripts/cleanup-placeholder-dbs.sh
# SAFETY: Checks file size (0 bytes) and open handles (lsof) before removal
# RUN ONCE: This is a one-time migration, not for repeated use
#
# Files removed:
#   - ~/.openclaw/projects/social-history.sqlite (0 bytes, real db is ~/.openclaw/social-history.sqlite)
#   - ~/.openclaw/social.sqlite (0 bytes, placeholder from old architecture)
#   - ~/.openclaw/knowledge-base.sqlite (0 bytes, real db is ~/.openclaw/projects/knowledge-base/kb.sqlite)
#
# Prerequisites: Stop all services before running
#   launchctl stop ai.openclaw.gateway
#   launchctl stop ai.openclaw.embedding-server
#   launchctl stop ai.openclaw.file-watcher
```

Create verification section at end of script:

```bash
echo ""
echo "=== Verification ==="
echo "Real databases that should remain:"
ls -lh "$HOME/.openclaw/observability.sqlite" 2>/dev/null || echo "WARNING: observability.sqlite missing"
ls -lh "$HOME/.openclaw/social-history.sqlite" 2>/dev/null || echo "WARNING: social-history.sqlite missing"
ls -lh "$HOME/.openclaw/autonomy.sqlite" 2>/dev/null || echo "WARNING: autonomy.sqlite missing"
ls -lh "$HOME/.openclaw/projects/knowledge-base/kb.sqlite" 2>/dev/null || echo "WARNING: kb.sqlite missing"
ls -lh "$HOME/.openclaw/memory/main.sqlite" 2>/dev/null || echo "WARNING: memory main.sqlite missing"
ls -lh "$HOME/.openclaw/projects/personal-ceo/ceo.sqlite" 2>/dev/null || echo "WARNING: ceo.sqlite missing"

echo ""
echo "Placeholders that should be gone:"
ls -lh "$HOME/.openclaw/projects/social-history.sqlite" 2>/dev/null && echo "STILL EXISTS (unexpected)" || echo "✓ Removed"
ls -lh "$HOME/.openclaw/social.sqlite" 2>/dev/null && echo "STILL EXISTS (unexpected)" || echo "✓ Removed"
ls -lh "$HOME/.openclaw/knowledge-base.sqlite" 2>/dev/null && echo "STILL EXISTS (unexpected)" || echo "✓ Removed"
```

Why verification: User needs confidence placeholders are gone and real databases untouched. Clear before/after comparison.

Why prerequisites: Services must be stopped to prevent lsof check from blocking removal. Document this upfront.
</action>
<verify>
<automated>grep -q "USAGE:" scripts/cleanup-placeholder-dbs.sh && grep -q "Prerequisites:" scripts/cleanup-placeholder-dbs.sh</automated>
</verify>
<done>

- cleanup-placeholder-dbs.sh has usage documentation
- Prerequisites clearly documented (stop services first)
- Verification section confirms cleanup success
- Script is ready for user to run manually
  </done>
  </task>

</tasks>

<verification>

**Requirement validation:**

- DATA-05: Run cleanup-placeholder-dbs.sh, verify 3 placeholder files removed and 6 real databases remain
- DATA-07: Source load-env.sh, verify API keys load from auth-profiles.json (echo $ANTHROPIC_API_KEY should have value)

**Integration checks:**

- After cleanup: `ls ~/.openclaw/*.sqlite ~/.openclaw/**/*.sqlite` shows only real databases
- After load-env update: `bash -c 'source scripts/load-env.sh && env | grep API_KEY'` shows keys from auth-profiles
- No plist references in load-env.sh: `grep -i plist scripts/load-env.sh` returns nothing

**Manual verification:**

1. Stop services: `launchctl stop ai.openclaw.gateway ai.openclaw.embedding-server ai.openclaw.file-watcher`
2. Run cleanup: `./scripts/cleanup-placeholder-dbs.sh`
3. Verify output shows "Removed placeholder:" for 3 files
4. Check real databases untouched: `ls -lh ~/.openclaw/observability.sqlite` (should exist)
5. Restart services: `launchctl start ai.openclaw.gateway` etc.
   </verification>

<success_criteria>

**Must be TRUE:**

1. Placeholder 0-byte SQLite files removed from ~/.openclaw/
2. Real databases (kb, observability, social-history, autonomy, ceo, memory) remain intact
3. cleanup script checks file size and open handles before removal (safety first)
4. load-env.sh loads credentials from auth-profiles.json only (no plist fallback)
5. Missing auth-profiles.json causes clear error (fail fast, don't silently fallback)
6. User has documented one-time migration script with prerequisites

**Observable artifacts:**

- `scripts/cleanup-placeholder-dbs.sh` exists and is executable
- `scripts/load-env.sh` references auth-profiles.json, no plist fallback
- After running cleanup: `find ~/.openclaw -name "*.sqlite" -size 0` returns nothing
- Real databases verified: 6 databases remain (observability, social-history, autonomy, kb, memory, ceo)

**Metrics:**

- 1 file created (cleanup-placeholder-dbs.sh)
- 1 file modified (load-env.sh)
- 3 placeholder files removed (social-history, social, knowledge-base placeholders)
- 0 real databases affected (all 6 remain intact)
- Single source of truth established (auth-profiles.json only)
  </success_criteria>

<output>
After completion, create `.planning/phases/18-data-integrity-config-safety/18-03-SUMMARY.md` documenting:
- Placeholder file cleanup completed safely
- Plist fallback removed from credential loading
- Single source of truth established for API credentials
- One-time migration script ready for user execution
- User instructions: Stop services, run cleanup, restart services

**User action required:**
Run the cleanup script ONCE after phase completion:

```bash
# Stop services
launchctl stop ai.openclaw.gateway
launchctl stop ai.openclaw.embedding-server
launchctl stop ai.openclaw.file-watcher

# Run cleanup
./scripts/cleanup-placeholder-dbs.sh

# Restart services
launchctl start ai.openclaw.gateway
launchctl start ai.openclaw.embedding-server
launchctl start ai.openclaw.file-watcher
```

</output>
