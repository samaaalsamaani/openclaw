---
phase: 18-data-integrity-config-safety
plan: "02"
type: execute
wave: 2
depends_on: ["18-01"]
files_modified:
  - src/infra/credential-monitor.ts
  - src/infra/credential-monitor.test.ts
  - src/agents/auth-profiles/types.ts
  - src/agents/auth-profiles/store.ts
  - scripts/daily-tasks.sh
  - package.json
autonomous: true
requirements: [DATA-03, DATA-04, DATA-07]

must_haves:
  truths:
    - Credential expiry is checked daily via heartbeat task
    - macOS notifications appear 7 days before OAuth token expiry
    - OAuth refresh attempts automatically before expiry
    - Refresh success updates access token and expiresAt in auth-profiles.json atomically
    - Refresh failure triggers user notification with manual renewal instructions
    - Auth-profiles.json is single source of truth (no plist fallback)
  artifacts:
    - path: src/infra/credential-monitor.ts
      provides: Daily credential expiry checks and OAuth refresh
      exports: [checkCredentialExpiry, refreshOAuthToken, sendExpiryNotification]
      min_lines: 100
    - path: src/infra/credential-monitor.test.ts
      provides: Expiry detection and refresh validation tests
      contains: "describe('checkCredentialExpiry'"
      min_lines: 50
    - path: src/agents/auth-profiles/types.ts
      provides: OAuthCredential with expiresAt field
      contains: "expiresAt"
    - path: scripts/daily-tasks.sh
      provides: Credential monitoring integration
      contains: "credential-monitor"
  key_links:
    - from: scripts/daily-tasks.sh
      to: src/infra/credential-monitor.ts
      via: "daily heartbeat calls checkCredentialExpiry"
      pattern: "node.*credential-monitor"
    - from: src/infra/credential-monitor.ts
      to: src/agents/auth-profiles/store.ts
      via: "loads auth-profiles.json for expiry checking"
      pattern: "loadAuthProfileStore"
    - from: src/infra/credential-monitor.ts
      to: node-notifier
      via: "sends macOS notifications on expiry"
      pattern: "notifier.notify"
    - from: src/agents/auth-profiles/store.ts
      to: src/infra/credential-monitor.ts
      via: "saveAuthProfileStore after successful refresh"
      pattern: "saveAuthProfileStore"

user_setup:
  - service: codex
    why: "OAuth token expires Mar 3, 2026 (4 days!)"
    env_vars: []
    dashboard_config:
      - task: "Re-authorize if auto-refresh fails"
        location: "Browser will auto-open to Codex OAuth flow"
        note: "Notification will appear 7 days before expiry with renewal link"
  - service: late.dev
    why: "YouTube, TikTok, Twitter tokens expire every 60 days"
    env_vars: []
    dashboard_config:
      - task: "Re-authorize if auto-refresh fails"
        location: "Late.dev dashboard -> Connections"
        note: "Auto-refresh attempts first, manual only if refresh fails"
---

<objective>
Automate credential expiry monitoring and OAuth token refresh to prevent surprise authentication failures.

Purpose: Codex OAuth expires Mar 3 (4 days!), Late.dev tokens expire every 60 days. Proactive monitoring with 7-day notification window prevents service outages. OAuth refresh automation eliminates manual token renewal.

Output: Daily credential monitoring in heartbeat, OAuth refresh automation with notification fallback, auth-profiles.json schema update with expiresAt tracking.
</objective>

<execution_context>
@/Users/user/.claude/get-shit-done/workflows/execute-plan.md
@/Users/user/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/18-data-integrity-config-safety/18-CONTEXT.md
@.planning/phases/18-data-integrity-config-safety/18-RESEARCH.md

# Auth-profiles structure

@src/agents/auth-profiles/types.ts
@src/agents/auth-profiles/store.ts
</context>

<interfaces>
<!-- Key types and contracts from existing codebase -->

From src/agents/auth-profiles/types.ts:

```typescript
export type OAuthCredential = OAuthCredentials & {
  type: "oauth";
  provider: string;
  clientId?: string;
  email?: string;
  // MISSING: expiresAt field (Task 1 adds this)
};

export type AuthProfileStore = {
  version: number;
  profiles: Record<string, AuthProfileCredential>;
  order?: Record<string, string[]>;
  lastGood?: Record<string, string>;
  usageStats?: Record<string, ProfileUsageStats>;
};
```

From src/agents/auth-profiles/store.ts:

```typescript
// Functions to add/find:
export function loadAuthProfileStore(path: string): AuthProfileStore;
export function saveAuthProfileStore(path: string, store: AuthProfileStore): void;
```

From @mariozechner/pi-ai (already installed):

```typescript
export type OAuthCredentials = {
  accessToken: string;
  refreshToken?: string;
  // Pattern: refresh tokens are optional, some providers rotate them
};
```

From node-notifier (needs installation):

```typescript
import notifier from "node-notifier";
notifier.notify({
  title: string;
  message: string;
  sound?: boolean;
  open?: string; // URL to open on click
});
```

From scripts/daily-tasks.sh (existing heartbeat):

```bash
#!/bin/bash
# Daily tasks at 07:00 via launchd
# Add credential monitoring call here
```

</interfaces>

<tasks>

<task type="auto">
  <name>Task 1: Add expiresAt field to OAuthCredential type</name>
  <files>
    src/agents/auth-profiles/types.ts
  </files>
  <action>
Update src/agents/auth-profiles/types.ts:
- Add expiresAt?: number field to OAuthCredential type (timestamp in ms since epoch)
- Add JSDoc comment: "@param expiresAt - Token expiry timestamp (ms since epoch), undefined if unknown"
- This is additive change (optional field), maintains backward compatibility with existing auth-profiles.json files
- No migration needed - old profiles without expiresAt continue working, new OAuth flows populate it

Why optional: Existing auth-profiles.json doesn't have expiresAt. Making it required breaks all existing credentials. Monitoring code treats undefined as "unknown expiry" (can't check, skip monitoring).
</action>
<verify>
<automated>pnpm check && pnpm test src/agents/auth-profiles/types.test.ts -x || echo "No types test file, checking compilation only"</automated>
</verify>
<done>

- OAuthCredential type has expiresAt?: number field
- TypeScript compilation succeeds
- Backward compatible with existing auth-profiles.json (optional field)
  </done>
  </task>

<task type="auto">
  <name>Task 2: Create credential monitoring module</name>
  <files>
    src/infra/credential-monitor.ts
    src/infra/credential-monitor.test.ts
    package.json
  </files>
  <action>
Install node-notifier for macOS notifications:
- Run: pnpm add node-notifier -w
- Updates package.json and pnpm-lock.yaml

Create src/infra/credential-monitor.ts with:

1. Import node-notifier, auth-profiles store functions, fs/promises
2. Export checkCredentialExpiry(storePath: string) that:
   - Loads auth-profiles.json via loadAuthProfileStore
   - Iterates profiles, filters to type === "oauth"
   - For each OAuth profile: checks expiresAt (skip if undefined)
   - Calculates timeUntilExpiry = expiresAt - Date.now()
   - If expired (timeUntilExpiry <= 0): calls attemptRefresh
   - If expiring within 7 days (timeUntilExpiry <= 7 _ 24 _ 60 _ 60 _ 1000): calls sendExpiryNotification + attemptRefresh
   - Otherwise: skip (not expiring soon)

3. Export attemptRefresh(profileId: string, cred: OAuthCredential, store: AuthProfileStore, storePath: string) that:
   - Checks if cred.refreshToken exists - if not, calls sendManualRenewalNotification and returns
   - Calls refreshOAuthToken(cred) with try/catch
   - On success: Updates cred.accessToken, cred.expiresAt, cred.refreshToken (if rotated), saves store via saveAuthProfileStore, logs success
   - On failure: Logs error, calls sendManualRenewalNotification
   - Atomic save: write to temp file, then rename (prevents partial writes)

4. Export refreshOAuthToken(cred: OAuthCredential) that:
   - Implements OAuth2 refresh token flow (RFC 6749 Section 6)
   - POSTs to provider token endpoint with grant_type=refresh_token, refresh_token=cred.refreshToken, client_id=cred.clientId
   - Parses response: { access_token, expires_in, refresh_token? }
   - Returns: { accessToken, expiresAt: Date.now() + expires_in \* 1000, refreshToken? }
   - Provider endpoints: Map cred.provider to known OAuth endpoints (Codex, Late.dev)
   - Throws on HTTP errors or invalid responses

5. Export sendExpiryNotification(profileId: string, daysLeft: number) that:
   - Calls notifier.notify with title="PAIOS Credential Expiry", message=`${profileId} expires in ${daysLeft} days`, sound=true
   - Returns void (fire-and-forget notification)

6. Export sendManualRenewalNotification(profileId: string, provider: string) that:
   - Calls notifier.notify with title="PAIOS Manual Renewal Required", message=`${profileId} needs re-authentication`, open=`https://docs.paios.ai/auth/${provider}`, sound=true
   - Returns void

Create src/infra/credential-monitor.test.ts with vitest tests:

- Module exports validation (all 5 functions exported)
- checkCredentialExpiry interface signature
- Expiry detection logic validation (7-day window calculation)
- OAuth refresh error handling (missing refresh token, network failure)
- 8-10 focused tests validating behavior contracts (mock fs and fetch operations)

Why 7 days: Gives user time to manually intervene if auto-refresh fails. Too short (1 day) = stress, too long (14 days) = forget.

Why atomic save: Token rotation means old refresh token invalidated when new one issued. Non-atomic save risks losing both tokens mid-write.
</action>
<verify>
<automated>pnpm test src/infra/credential-monitor.test.ts -x</automated>
</verify>
<done>

- node-notifier installed in package.json
- credential-monitor.ts exports 5 functions (checkCredentialExpiry, attemptRefresh, refreshOAuthToken, sendExpiryNotification, sendManualRenewalNotification)
- Test suite passes with 8-10 tests
- TypeScript compilation succeeds
- OAuth refresh flow follows RFC 6749 pattern
  </done>
  </task>

<task type="auto">
  <name>Task 3: Integrate credential monitoring into daily heartbeat</name>
  <files>
    scripts/daily-tasks.sh
    src/agents/auth-profiles/store.ts
  </files>
  <action>
Update scripts/daily-tasks.sh (existing heartbeat script):
- Find the daily task execution section (around "Daily tasks at 07:00" or similar)
- Add credential monitoring call BEFORE other tasks (credentials needed for API calls):
  ```bash
  # Check credential expiry (7-day notification window)
  node -e "import('./src/infra/credential-monitor.js').then(m => m.checkCredentialExpiry('$HOME/.openclaw/auth-profiles.json'))" || echo "Credential check failed"
  ```
- Use ESM import pattern (matches other scripts)
- Graceful failure (|| echo) - don't block other daily tasks if credential check fails
- Log to stdout (captured by launchd logs)

Update src/agents/auth-profiles/store.ts:

- Verify loadAuthProfileStore and saveAuthProfileStore functions exist and are exported
- If missing, add them:
  - loadAuthProfileStore(path): reads JSON file, parses, validates version, returns AuthProfileStore
  - saveAuthProfileStore(path, store): validates store, writes JSON with 2-space indent, syncs to disk
- Add backup before save (import rotateConfigBackups from backup-rotation.ts)
- Both functions handle errors gracefully (log, don't crash)

Why daily: Credentials don't expire hourly. Daily check is sufficient with 7-day notification window. Reduces notification spam.

Why before other tasks: If credentials expire overnight, daily tasks (social posting, competitor sweep) fail. Check and refresh first.

Note: If store.ts already has these functions, just verify they're exported and have backup rotation. Don't duplicate.
</action>
<verify>
<automated>bash -n scripts/daily-tasks.sh && pnpm check</automated>
</verify>
<done>

- daily-tasks.sh calls credential monitoring at 07:00
- Store functions exist and handle backup rotation
- Script syntax validation passes
- TypeScript compilation succeeds
- Next daily heartbeat will check credentials and send notifications if expiring
  </done>
  </task>

</tasks>

<verification>

**Requirement validation:**

- DATA-03: Run checkCredentialExpiry with test auth-profiles.json containing expiring credential, verify notification appears
- DATA-04: Mock Codex OAuth refresh, verify access token and expiresAt update atomically
- DATA-07: Verify auth-profiles.json loads without plist fallback (grep for plist in load-env.sh, should find NO fallback logic)

**Integration checks:**

- Daily heartbeat executes credential monitoring (check launchd logs: `log show --predicate 'subsystem == "ai.openclaw.daily-tasks"' --last 1d`)
- OAuth refresh with valid refresh token updates auth-profiles.json atomically
- macOS notification appears when credential expires within 7 days
- Manual renewal notification includes clickable docs URL

**Manual verification:**

1. Set test credential with expiresAt = Date.now() + 6 _ 24 _ 60 _ 60 _ 1000 (6 days), run monitoring → notification should appear
2. Mock OAuth refresh response, verify auth-profiles.json updated with new tokens
3. Check daily-tasks.sh runs: `launchctl list | grep daily-tasks` → should show service running
   </verification>

<success_criteria>

**Must be TRUE:**

1. Credential expiry checking runs daily at 07:00 via launchd heartbeat
2. OAuth tokens expiring within 7 days trigger macOS notification
3. Auto-refresh attempts before notifying user (refresh first, notify if refresh fails)
4. Successful refresh updates access token, expiresAt, and refreshToken (if rotated) in auth-profiles.json
5. Failed refresh opens browser to manual renewal URL via notification
6. Auth-profiles.json is single source of truth (no plist fallback causing drift)

**Observable artifacts:**

- `src/infra/credential-monitor.ts` exports 5 credential monitoring functions
- `src/agents/auth-profiles/types.ts` has expiresAt field in OAuthCredential
- `scripts/daily-tasks.sh` calls credential monitoring
- node-notifier installed in package.json
- Daily launchd logs show credential monitoring execution

**Metrics:**

- 2 files created (credential-monitor.ts + test)
- 3 files modified (types.ts, store.ts, daily-tasks.sh)
- 1 dependency added (node-notifier)
- ~10 tests added validating expiry detection and refresh
- Zero manual credential renewals needed for tokens with valid refresh tokens
  </success_criteria>

<output>
After completion, create `.planning/phases/18-data-integrity-config-safety/18-02-SUMMARY.md` documenting:
- Credential monitoring integrated into daily heartbeat
- OAuth refresh automation with 7-day notification window
- Auth-profiles.json schema updated with expiresAt tracking
- Manual renewal flow for refresh token failures
- Codex OAuth renewal urgency (Mar 3 expiry) addressed
</output>
